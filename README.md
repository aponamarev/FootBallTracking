# FootBallTracking

The goals of this project is to create a pipeline for football player detection on the field. The pipeline includes the following steps:

* Train CNN for detecting and localizing people: as a basis I use a modified version of SqueezeDet (inspired by YOLO) - tensorflow implementation
* Localize football players position (bounding boxes) using CNN described in step 1
* Assign player’s role based on starting position and track changes of bounding box frame to frame

**Author/Ownder/Mainter:** Alexander Ponamarev
Project prepared for **AraJoy.ai**



[//]: # (Image References)
[squeezedet]: ./Examples/SqueezeDet.png
[person1]: ./Examples/person1.png
[person2]: ./Examples/person2.png
[person3]: ./Examples/person3.png
[vehicle]: ./Examples/vehicle.png
[class_loss]: ./Examples/class_loss.png
[bbox_loss]: ./Examples/bbox_loss.png
[total_loss]: ./Examples/total_loss.png
[football_positions]: ./Examples/football_positions.png


---
## README

Approach - Overall approach is based on the assumption that it is possible to identify football player's role on the file given it initial position. For examaple:
![alt_text][football_positions]

Given the knowledge of player's initial position, it would be possible to track the coordinates of a bounding box (frame to frame) closest to the player to track player's position on the field.

This approach has an obvious drawback - overlapping / close positions. In a scenario where two player's get too close to each other, it would be difficult for an algorithm to decide which bounding box is associated with the original player.

To tackle this problem I suggest to use a trajectory as a discriminative factor.

### 1. Train CNN

In order to train CNN I am using MS COCO. The CNN will be trained to detect “person”, "vehicle", "bicycle", "motorcycle". Training several classes creates a redundancy as we will only use "person" class as the main classifier. However, in order to differentiate a person from any other object, it is important to provide any other class to discriminate agains (otherwise class error always will be 0).

Later, I will use this detector to identify football players. Depending on the performance of this detector, there might be a need to fine-tune this detector on a smaller, football-centric data.

Examples of training images are presented below:
![alt_text][person1] | ![alt_text][person2]
![alt_text][person3] | ![alt_text][vehicle]

#### Net Architecture

As a basis for my net architecture I chose SqueezeDet (inspired by YOLO). This framework allows to train detection pipeline end-to-end with high efficiency through one unified loss function presented below:

W_bbox * bbox_loss + C_loss + W_ce * P_loss

        Where:

        bbox_loss = mask * ( (dx' - dx)^2 + (dy' - dy)^2 + (dw'-dw)^2 + (dh'-dh)^2 )
            -   mask is 1 if anchor and ground truth input_mask is this highest and 0 otherwise
                dx, dy, dw, dh - distance between ground truth and anchors center, width and height
                dx', dy', dw', dh' - model estimates

        C_loss = W_pos/N_obj * mask * (confidence' - 1)^2 + W_neg/(WHK-N_obj) * (1-mask) * confidence'^2
            -   W_pos/N_obj and W_neg/(WHK-N_obj) are normalized weights of the loss

        P_loss = mask * OHE(label)*log(Pc) / N_obj

Reference:
        Wu, B., Iandola, F., Jin, P. H., Keutzer, K., Huang, J., Rathod, V., … Research, G. (2016).
        SqueezeDet: Unified, Small, Low Power Fully Convolutional Neural Networks for Real-Time Object Detection
        for Autonomous Driving. arXiv.

        arxiv.org. 2017. No page title. [ONLINE] Available at: https://arxiv.org/abs/1612.01051. [Accessed 17 June 2017].

In addition, the architecture of this network relies on feature pyramid presented in research paper: Feature Pyramid Networks for Object Detection. Feature pyramid allows to incorporate more granular, translation variant information from lower levels of the network into the predictions generated by higher layers.

Reference:
		Feature Pyramid Networks for Object Detection

		Tsung-Yi Lin, Piotr Dollár, Ross Girshick, Kaiming He, Bharath Hariharan, Serge Belongie
		(Submitted on 9 Dec 2016 (v1), last revised 19 Apr 2017 (this version, v2))
		arxiv.org. 2017. No page title. [ONLINE] Available at: https://arxiv.org/abs/1612.03144. [Accessed 17 June 2017].

High level network architecture is presented below:
![alt_text][squeezedet]

The network is based on a series of convolutional and deconvolutional layers strengthen with batch normalization. The training is done using Adam Loss minimization technique. Only after one hour of training, the net shows a good loss optimization trend:
![alt_text][total_loss]

Class discrimination subtask is especially successful:
![alt_text][class_loss]

#### Software

For training and deployment purpose I use a Python 3.5 and a combination of libraries (TensorFlow, Numpy, OpenCV, and otether). All of the packages provided as a Conda environment or pip requirements list:

Conda:
Ubuntu - with GPU support: environment_ubuntu_GPU.yml
MacOS - CPU only: environment_mac_cpu.yml

PIP:
requirements.txt


#### Hardware

For trainnig purpose I use an EC2 instance from AWS. This instance is launched on spot basis for cost efficiency. Therefore, training repository is located on an external harddrive.

Instance specification:
Instance type: p2.xlarge
AMI ID: Alex-Udacity-CarND (ami-5fc5a149)

Instance is equiped with NVIDIA GPU. GPU specification is presented below:
name: Tesla K80
major: 3 minor: 7 memoryClockRate (GHz) 0.8235
Total memory: 11.17GiB

For more information contact: Alexander Ponamarev (alex.ponamaryov@gmail.com)


